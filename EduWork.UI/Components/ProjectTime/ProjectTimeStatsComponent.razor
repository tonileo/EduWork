@using Common.DTO
@using Common.DTO.ProjectTime
@using EduWork.UI.Shared

@inject HttpClient Http

<EditForm Model="@filterModel" OnValidSubmit="LoadProjectTimesAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row">
        <div class="col-md-3 col-sm-6">
            <div class="form-group">
                <InputDate class="form-control" @bind-Value="filterModel.FromDate" id="fromDate" />
                <ValidationMessage For="() => filterModel.FromDate" />
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="form-group">
                <InputDate class="form-control" @bind-Value="filterModel.ToDate" id="toDate" />
                <ValidationMessage For="() => filterModel.ToDate" />
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="form-group">
                <InputText class="form-control" @bind-Value="filterModel.ProjectTitle" id="projectTitle"
                           placeholder="Naziv projekta..." />
                <ValidationMessage For="() => filterModel.ProjectTitle" />
            </div>
        </div>

        @if (haveUsername)
        {
            <div class="col-md-3 col-sm-6">
                <div class="form-group">
                    @if (usernames == null)
                    {
            <option>Loading...</option>
                    }
                    else
                    {
            <InputSelect class="form-control" @bind-Value="filterModel.Username" id="username">
                <option value="">Odaberi korisnika...</option>
                            @foreach (var user in usernames)
                            {
                    <option value="@user.Username">@user.Username</option>
                            }
            </InputSelect>
            <ValidationMessage For="() => filterModel.Username" />
                    }
        </div>
        </div>
        }

    </div>
    <div class="col-md-3 col-sm-6">
        <br />
        <button type="submit" class="btn btn-primary">Filtriraj</button>
    </div>
</EditForm>

<br>
<div class="row">
    <div class="col-md-6">

        @if (projectTimeResponse == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <table class="table @(haveUsername ? string.Empty : "table-striped")">
                <thead>
                    <tr>
                        <th>Projekt</th>
                        <th style="text-align: right;">Trajanje</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var sum in projectTimeResponse.ProjectTimeSums.OrderByDescending(p => p.PercentageTimeSpent))
                    {
                        <tr class="@GetRowClass(sum.IsEducation, sum.IsFinished)">
                            <td>
                                @if (haveUsername)
                                {
                                    @if (!sum.IsPayable)
                                    {
                                        <span class="legend-circle" style="background-color: red;"></span>
                                    }
                                    else
                                    {
                                        <span class="legend-circle" style="background-color: forestgreen;"></span>
                                    }
                                }
                                else
                                {
                                    @if (sum.IsEducation)
                                    {
                                        <span class="legend-circle" style="background-color: #2196F3;"></span>
                                    }
                                    else
                                    {
                                        <span class="legend-circle" style="background-color: black;"></span>
                                    }
                                }
                                @sum.TitleProject
                            </td>
                            <td style="text-align: right;"><span>@sum.SumTimeSpentHours</span>h : <span>@sum.SumTimeSpentMinutes</span>min</td>
                        </tr>
                    }
                    <tr>
                        <td><strong>Ukupno</strong></td>
                        <td style="text-align: right;">
                            <strong><span>@projectTimeResponse.SumAllProjectTimesHours</span>h : <span>@projectTimeResponse.SumAllProjectTimesMinutes</span>min</strong>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top: 20px;">
                <ul style="list-style-type: none; padding: 0;">
                    @if (haveUsername)
                    {
                        <li style="display: inline-block; margin-right: 15px;">
                            <span class="legend-circle" style="background-color: red;"></span>
                            <span>Ne plaćen</span>
                        </li>

                        <li style="display: inline-block; margin-right: 15px;">
                            <span class="legend-circle" style="background-color: forestgreen;"></span>
                            <span>Plaćen</span>
                        </li>
                    }
                    <li style="display: inline-block; margin-right: 15px;">
                        <span class="legend-circle" style="background-color: #2196F3;"></span>
                        <span>Edukacija</span>
                    </li>

                    <li style="display: inline-block; margin-right: 15px;">
                        <span class="legend-circle" style="background-color: #757575;"></span>
                        <span>Završen</span>
                    </li>
                </ul>
            </div>
        }
    </div>

    <div class="col-md-6" style="background-color: lightcyan; padding: 20px; border-radius: 8px; display: flex;
flex-direction: row; justify-content: space-between; height: 100%; margin-top: 20px;">

        @if (projectTimeResponse != null)
        {
            <ChartComponent projectTimeSumDto="projectTimeResponse.ProjectTimeSums"></ChartComponent>
        }
        else
        {
            <p>Loading...</p>
        }

        <div>
            <div style="margin-bottom: 30px;">
                <p style="font-size: 18px; margin-bottom: 5px;">Provedeno vremena:</p>
                <p style="font-size: 20px;">
                    <strong><span>@projectTimeResponse?.SumAllProjectTimesHours</span> h : <span>@projectTimeResponse?.SumAllProjectTimesMinutes</span> min</strong>
                </p>
            </div>
            @foreach (var percentageTime in projectTimeResponse?.ProjectTimeSums ?? Enumerable.Empty<ProjectTimeSumDto>())
            {
                <div style="display: inline-block; vertical-align: top; margin-right: 20px; border-radius: 8px; padding-right: 20px; box-shadow: 3px 3px 5px rgba(0,0,0,0.4);">
                    <p style="font-size: 24px; margin-bottom: 5px; margin-top: 0;">@percentageTime.PercentageTimeSpent%</p>
                    <strong><p style="font-size: 14px; margin-bottom: 5px; margin-top: 5px;">@percentageTime.TitleProject</p></strong>
                </div>
            }
        </div>
    </div>

</div>

@code {
    [Parameter]
    public string? ApiEndpoint { get; set; }

    [Parameter]
    public bool haveUsername { get; set; }

    private ProjectTimeResponseDto? projectTimeResponse;
    private List<UsernamesDto>? usernames;

    private FilterModel filterModel = new FilterModel();

    protected override async Task OnInitializedAsync()
    {
        filterModel.FromDate = DateTime.Today.AddMonths(-1);

        filterModel.ToDate = DateTime.Today;

        if (haveUsername)
        {
            usernames = await Http.GetFromJsonAsync<List<UsernamesDto>>("api/ProjectTimes/usernames");
        }

        await LoadProjectTimesAsync();
    }

    private async Task LoadProjectTimesAsync()
    {
        string parameters;

        string respondfromDate = $"fromDate={filterModel.FromDate:yyyy-MM-ddTHH:mm:ss}";
        string respondToDate = $"toDate={filterModel.ToDate:yyyy-MM-ddTHH:mm:ss}";

        if (haveUsername)
        {
            parameters = $"{respondfromDate}&{respondToDate}&username={filterModel.Username}&projectTitle={filterModel.ProjectTitle}";
        }
        else
        {
            parameters = $"{respondfromDate}&{respondToDate}&projectTitle={filterModel.ProjectTitle}";
        }

        projectTimeResponse = await Http.GetFromJsonAsync<ProjectTimeResponseDto>($"{ApiEndpoint}?{parameters}");
    }

    private string GetRowClass(bool isEducation, bool isFinished)
    {
        string rowClass = string.Empty;

        if (haveUsername == true)
        {
            if (isEducation)
            {
                rowClass += "education-row ";
            }
        }

        if (isFinished)
        {
            rowClass += "finished-row";
        }

        return rowClass.Trim();
    }
}